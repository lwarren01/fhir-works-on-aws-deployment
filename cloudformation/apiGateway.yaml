#
#  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
#  SPDX-License-Identifier: Apache-2.0
#

Resources:
  FHIRServicePrivate:
    Type: AWS::ApiGateway::RestApi
    Condition: isUsingPrivateApi
    DependsOn:
      - ApiGatewayRestApi
      - ApiGatewayMethodMetadataGet
      - FhirServerLambdaFunction
      - FhirServerProvConcLambdaAlias
    Properties:
      Name: !Join ['-', [!Ref Stage, fhir, service, private]]
      Description: "Private fwoa FHIR API Server"
      CloneFrom: !Ref ApiGatewayRestApi
      EndpointConfiguration:
        Types:
          - PRIVATE
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: 'execute-api:Invoke'
            Resource: 'execute-api:/*/*/*'
      Tags:
        - Key: 'stage'
          Value: !Ref Stage
  
  FHIRServiceStageDeployment:
    Type: AWS::ApiGateway::Deployment
    Condition: isUsingPrivateApi
    DependsOn:
      - FHIRServicePrivate
      - FhirServerLambdaFunction
      - FhirServerProvConcLambdaAlias
    Properties: 
      RestApiId: !Ref FHIRServicePrivate
      StageName: !Ref Stage
      Description: !Sub 'Private API Gateway for ${Stage}'
      StageDescription:
        AccessLogSetting:
          DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
          Format: ${self:provider.logs.restApi.format}
        TracingEnabled: ${self:provider.tracing.apiGateway}
        # the below */* method settings are explicitly being set by serverless
        # however defaults match in API gateway and for an unknnown reason 
        # serverless deploy is failing when setting them
        #MethodSettings:
        #  - CacheDataEncrypted: true
        #    CacheTtlInSeconds: '300'
        #    CachingEnabled: false
        #    DataTraceEnabled: true
        #    HttpMethod: "*"
        #    LoggingLevel: "OFF"
        #    MetricsEnabled: false
        #    ResourcePath: "*"
        #    ThrottlingBurstLimit: '5000'
        #    ThrottlingRateLimit: '10000.0'

  #FHIRServicePrivateStage:
  #  Type: AWS::ApiGateway::Stage
  #  Condition: isUsingPrivateApi
  #  DependsOn:
  #    - FHIRServicePrivate
  #    - FhirServerLambdaFunction
  #    - FhirServerProvConcLambdaAlias
  #    - FHIRServiceStageDeployment
  #  Properties:
  #    RestApiId: !Ref FHIRServicePrivate
  #    StageName: !Ref Stage
  #    DeploymentId: !Ref FHIRServiceStageDeployment
  #    AccessLogSetting:
  #     DestinationArn: !GetAtt FHIRLogsBucket.Arn
  #     Format: ${self:provider.logs.restApi.format}
  #    TracingEnabled: ${self:provider.tracing.apiGateway}

  FHIRServicePrivateLambdaPermission:
    Type: AWS::Lambda::Permission
    Condition: isUsingPrivateApi
    DependsOn:
      - FHIRServicePrivate
      - FhirServerLambdaFunction
      - FhirServerProvConcLambdaAlias
    Properties:
      Action: "lambda:InvokeFunction"
      FunctionName: !Ref FhirServerProvConcLambdaAlias
      Principal: "apigateway.amazonaws.com"
      SourceArn: !Join ['', ['arn:', !Sub "${AWS::Partition}", ':execute-api:', !Sub "${AWS::Region}", ':', !Sub "${AWS::AccountId}", ':', !Ref FHIRServicePrivate, '/*/*']]

  FHIRServicePrivateUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Condition: isUsingPrivateApi
    DependsOn:
      - FHIRServiceStageDeployment
    Properties: 
      ApiStages: 
        - ApiId: !Ref FHIRServicePrivate
          Stage: !Ref Stage
      Description: !Join ['', ['Usage plan for ', !Join ['-', [!Ref Stage, fhir, service, private]], ' ', !Ref Stage, ' stage']]
      #Tags: ${self.provider.stackTags}
      Throttle:
        BurstLimit: ${self:provider.usagePlan.throttle.burstLimit}
        RateLimit: ${self:provider.usagePlan.throttle.rateLimit}
      UsagePlanName: !Join ['-', [fhir, service, !Ref Stage, private]]
  
  FHIRServicePrivateUsagePlanKey:
    Type: AWS::ApiGateway::UsagePlanKey
    Condition: isUsingPrivateApi
    Properties: 
      KeyId: !Ref ApiGatewayApiKey1
      KeyType: API_KEY
      UsagePlanId: !Ref FHIRServicePrivateUsagePlan



  #####
  # https://github.com/serverless/serverless/issues/9240
  # From fwoa 3.x to 4.x new restrictions for the API gateway cloudwatch logs role were added
  # specifically, https://github.com/awslabs/fhir-works-on-aws-deployment/commit/cc75ff762cf04621778a13f1673f7188d30bf59c
  # which is good to lock down more but unfortunately serverless+cloudformation fail to orchestrate a successful update
  # so, we need to manually do the update ourselves by creating a new role for API gateway's cloudwatch logs
  # and set the serverless configuration to not manage the role and which role to use instead
  # in a subsequent release we can then switch back to the out of the box fwoa definitions to create a new role
  # with the added restrictions managed by fwoa serverless+derived cloudformation
  #####
  ApiGatewayRestApiCloudwatchLogsCustomRole:
    Type: AWS::IAM::Role
    Properties: 
      AssumeRolePolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: 'Allow'
                Principal:
                  Service: 'apigateway.amazonaws.com'
                Action: 'sts:AssumeRole'
      Description: "Custom API gateway role for to use with cloudwatch logs"
      ManagedPolicyArns: 
        - 'arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs'
      RoleName: !Join ['-', ['serverlessApiGatewayCloudWatchRoleCustom', !Ref Stage]]